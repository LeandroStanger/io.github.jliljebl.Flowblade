id: io.github.jliljebl.Flowblade
branch: stable
runtime: org.gnome.Platform
runtime-version: '3.30'
sdk: org.gnome.Sdk
command: flowblade
finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=pulseaudio
  - --device=all
  - --filesystem=host
  - --env=FREI0R_PATH=/app/lib/frei0r-1
  - --env=LADSPA_PATH=/app/lib/ladspa
  - --env=DCONF_USER_CONFIG_DIR=.config/dconf
  - --filesystem=xdg-run/dconf
  - --filesystem=~/.config/dconf:ro
  - --talk-name=ca.desrt.dconf
cleanup:
  - /include
  - /lib/pkgconfig
  - /share/aclocal
  - /share/man
  - /share/pkgconfig
  - '*.a'
  - '*.la'
modules:
  - shared-modules/SDL/SDL-1.2.15.json
  - shared-modules/python2.7/python-2.7.15.json

  - name: eigen
    buildsystem: cmake-ninja
    builddir: true
    cleanup:
      - '*'
    sources:
      - type: archive
        url: https://bitbucket.org/eigen/eigen/get/3.3.5.tar.bz2
        sha256: 7352bff3ea299e4c7d7fbe31c504f8eb9149d7e685dec5a12fbaa26379f603e2

  - name: fftw
    config-opts:
      - --disable-doc
      - --enable-shared
      - --disable-static
      - --enable-threads
    build-options:
      arch:
        i386:
          config-opts:
            - --enable-avx
            - --enable-openmp
            - --enable-sse2
        x86_64:
          config-opts:
            - --enable-avx
            - --enable-openmp
            - --enable-sse2
    cleanup:
      - /bin
    sources:
      - type: archive
        url: http://www.fftw.org/fftw-3.3.8.tar.gz
        sha256: 6113262f6e92c5bd474f2875fa1b01054c4ad5040f6b0da7c03c98821d9ae303

  - name: fftw-float
    config-opts:
      - --disable-doc
      - --enable-shared
      - --disable-static
      - --enable-threads
      - --enable-float
    build-options:
      arch:
        i386:
          config-opts:
            - --enable-avx
            - --enable-openmp
            - --enable-sse
        x86_64:
          config-opts:
            - --enable-avx
            - --enable-openmp
            - --enable-sse
    cleanup:
      - /bin
    sources:
      - type: archive
        url: http://www.fftw.org/fftw-3.3.8.tar.gz
        sha256: 6113262f6e92c5bd474f2875fa1b01054c4ad5040f6b0da7c03c98821d9ae303

  - name: frei0r-plugins
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    sources:
      - type: archive
        url: https://files.dyne.org/frei0r/frei0r-plugins-1.6.1.tar.gz
        sha256: e0c24630961195d9bd65aa8d43732469e8248e8918faa942cfb881769d11515e

  - name: sox
    config-opts:
      - --disable-static
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://sourceforge.net/projects/sox/files/sox/14.4.2/sox-14.4.2.tar.bz2
        sha256: 81a6956d4330e75b5827316e44ae381e6f1e8928003c6aa45896da9041ea149c
        mirror-urls:
          - http://http.debian.net/debian/pool/main/s/sox/sox_14.4.2.orig.tar.bz2

  - name: dbus-python
    cleanup:
      - /share/doc
    sources:
      - type: archive
        url: https://dbus.freedesktop.org/releases/dbus-python/dbus-python-1.2.4.tar.gz
        sha256: e2f1d6871f74fba23652e51d10873e54f71adab0525833c19bad9e99b1b2f9cc

  - name: numpy
    buildsystem: simple
    build-commands:
      - python2 setup.py build -j $FLATPAK_BUILDER_N_JOBS install --prefix=/app
    cleanup:
      - /bin
      - /lib/python2.7/site-packages/numpy/tests
      - /lib/python2.7/site-packages/numpy/*/tests
    sources:
      - type: archive
        url: https://pypi.python.org/packages/ee/66/7c2690141c520db08b6a6f852fa768f421b0b50683b7bbcd88ef51f33170/numpy-1.14.0.zip
        sha256: 3de643935b212307b420248018323a44ec51987a336d1d747c1322afc3c099fb

  - name: pillow
    buildsystem: simple
    build-options:
      arch:
        i386:
          env:
            MAX_CONCURRENCY: '1'
    build-commands:
      - python2 setup.py install --prefix=/app --root=/
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://github.com/python-pillow/Pillow/archive/5.3.0.tar.gz
        sha256: 9de4853d8b640c0185665735a1c3266b6d51636b3a3d8e3ea7876c485194b6e1

  - name: pycairo
    buildsystem: simple
    build-commands:
      - python2 setup.py install --prefix=/app
    sources:
      - type: archive
        url: https://pypi.python.org/packages/ef/97/b33dc533ea6076d4ea9cbd2fe049a2b4a3df5c5b6fba9a182616f6f8d310/pycairo-1.15.4.tar.gz
        sha256: ee4c3068c048230e5ce74bb8994a024711129bde1af1d76e3276c7acd81c4357

  - name: pygobject
    build-options:
      env:
        PYTHON: /app/bin/python2
    sources:
      - type: archive
        url: https://download.gnome.org/sources/pygobject/3.28/pygobject-3.28.2.tar.xz
        sha256: ac443afd14fcb9ff5744b65d6e2b380e70510278404fb8684a9b9fb089e6f2ca

  - name: swig
    config-opts:
      - --without-alllang
      - --with-python=/app/bin/python2
      - --without-boost
      - --without-pcre
    cleanup:
      - '*'
    sources:
      - type: archive
        url: https://sourceforge.net/projects/swig/files/swig/swig-3.0.12/swig-3.0.12.tar.gz
        sha256: 7cf9f447ae7ed1c51722efc45e7f14418d15d7a1e143ac9f09a668999f4fc94d
        mirror-urls:
          - http://http.debian.net/debian/pool/main/s/swig/swig_3.0.12.orig.tar.gz

  - name: jack2
    buildsystem: simple
    build-commands:
      - ./waf configure --prefix=/app --htmldir=/app/share/doc/jack/ --freebob=no --classic
      - ./waf build -j $FLATPAK_BUILDER_N_JOBS
      - ./waf install
    cleanup:
      - /bin
      - /share
      - /lib/jack
      - /lib/libjackserver.so*
    sources:
      - type: archive
        url: https://github.com/jackaudio/jack2/releases/download/v1.9.12/jack2-1.9.12.tar.gz
        sha256: deefe2f936dc32f59ad3cef7e37276c2035ef8a024ca92118f35c9a292272e33  

  - name: swh-plugins
    sources:
      - type: archive
        url: https://github.com/swh/ladspa/archive/v0.4.17.tar.gz
        sha256: d1b090feec4c5e8f9605334b47faaad72db7cc18fe91d792b9161a9e3b821ce7

  - name: ladspa-sdk
    buildsystem: simple
    subdir: src
    build-commands:
      - make INSTALL_PLUGINS_DIR=/app/lib/ladspa/ INSTALL_INCLUDE_DIR=/app/include/ INSTALL_BINARY_DIR=/app/bin/ install
    sources:
      - type: archive
        url: https://www.ladspa.org/download/ladspa_sdk_1.13.tgz
        sha256: b5ed3f4f253a0f6c1b7a1f4b8cf62376ca9f51d999650dd822650c43852d306b

  - name: gmic
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DBUILD_LIB=OFF
      - -DBUILD_MAN=OFF
      - -DBUILD_BASH_COMPLETION=OFF
    sources:
      - type: archive
        url: https://gmic.eu/files/source/gmic_2.4.0.tar.gz
        sha256: ffc649c960f2dc52cea77039802a8c2b71f997ba300270e08fc2117e238614c3

  - name: libx264
    config-opts:
      - --disable-cli
      - --enable-shared
    sources:
      - type: archive
        url: https://download.videolan.org/x264/snapshots/x264-snapshot-20180807-2245-stable.tar.bz2
        sha256: 1439f1a054c87965089b646e77d16e1a8bf2f9687e4dd696ac518e44c7644c2a
  
  - name: ffmpeg
    config-opts:
      - --enable-gpl
      - --disable-static
      - --enable-shared
      - --disable-doc
      - --disable-programs
      - --enable-libfontconfig
      - --enable-libfreetype
      - --enable-libopus
      - --enable-librsvg
      - --enable-libvpx
      - --enable-libx264
      - --enable-libmp3lame
    cleanup:
      - /share/ffmpeg
    sources:
      - type: archive
        url: https://ffmpeg.org/releases/ffmpeg-4.0.2.tar.xz
        sha256: a95c0cc9eb990e94031d2183f2e6e444cc61c99f6f182d1575c433d62afb2f97

  - name: mlt
    config-opts:
      - --enable-gpl
      - --enable-gpl3
      - --swig-languages=python
      - --disable-gtk2
    post-install:
      - install -Dm644 src/swig/python/mlt.py /app/lib/python2.7/site-packages/mlt.py
      - install src/swig/python/_mlt.so /app/lib/python2.7/site-packages/_mlt.so
    cleanup:
      - /bin
    sources:
      - type: git
        url: https://github.com/mltframework/mlt.git
        commit: 4d086b86100d5a8c67ac272f41ced0394f282164

  - name: flowblade
    buildsystem: simple
    subdir: flowblade-trunk
    build-commands:
      - python2 setup.py install --prefix=/app --install-lib=/app/share/flowblade
    post-install:
      - mv /app/share/mime/packages/flowblade.xml /app/share/mime/packages/io.github.jliljebl.Flowblade.xml
      - mkdir -p /app/share/icons/hicolor/128x128/apps
      - mv /app/share/pixmaps/flowblade.png /app/share/icons/hicolor/128x128/apps/io.github.jliljebl.Flowblade.png
      - mv /app/share/applications/flowblade.desktop /app/share/applications/io.github.jliljebl.Flowblade.desktop
      - desktop-file-edit --set-key=Icon --set-value='io.github.jliljebl.Flowblade' /app/share/applications/io.github.jliljebl.Flowblade.desktop
      - desktop-file-edit --set-key=Exec --set-value='flowblade %f' /app/share/applications/io.github.jliljebl.Flowblade.desktop
      - desktop-file-edit --set-key=MimeType --set-value='application/flowblade' /app/share/applications/io.github.jliljebl.Flowblade.desktop
      - install -Dm644 ../io.github.jliljebl.Flowblade.appdata.xml /app/share/appdata/io.github.jliljebl.Flowblade.appdata.xml
      - sed -i 's|"/usr|"/app|g' /app/bin/flowblade /app/share/flowblade/Flowblade/tools/gmic.py
      - sed -i 's|/usr/share/locale|/app/share/flowblade/Flowblade/locale|g' /app/share/flowblade/Flowblade/translations.py
    cleanup:
      - /lib/mime
      - /share/pixmaps
    sources:
      - type: archive
        url: https://github.com/jliljebl/flowblade/archive/v1.16.tar.gz
        sha256: 2b33535ca92ed6c179cf804ccc9cd742194742bdddcad0bd8c3387ca7a4327ef
      - type: file
        path: io.github.jliljebl.Flowblade.appdata.xml
